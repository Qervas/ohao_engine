#!/usr/bin/env python
"""
OHAO Engine GDExtension Build Script
Builds the GDExtension that embeds OHAO's Vulkan renderer in Godot
"""

import os
import sys

# Build godot-cpp first
env = SConscript("godot-cpp/SConstruct")

# Add OHAO include paths
env.Append(CPPPATH=[
    "src/",
    "../src/",  # OHAO engine headers
    "../external/glm/",
    "../external/",
    "../build/_deps/glm-src/",  # GLM from FetchContent
    "/opt/homebrew/include/",  # Vulkan headers (MoltenVK)
])

# Add library paths
env.Append(LIBPATH=[
    "../build/",  # OHAO engine libraries
    "/opt/homebrew/lib/",  # Homebrew libraries (Vulkan, etc.)
])

# Link OHAO libraries (order matters for static linking - dependents first)
# ohao_ui is needed for ConsoleWidget logging
# Libraries that USE symbols must come BEFORE libraries that DEFINE them
env.Append(LIBS=[
    "ohao_renderer",   # Uses ConsoleWidget
    "ohao_scene",      # Uses ConsoleWidget
    "ohao_physics",    # Uses ConsoleWidget
    "ohao_component",  # Uses ConsoleWidget
    "ohao_ui",         # Defines ConsoleWidget (must come after users)
    "ohao_actor",
    "ohao_asset",
    "tinyfiledialogs", # File dialogs
])

# Platform-specific settings
if env["platform"] == "macos":
    env.Append(LINKFLAGS=[
        "-framework", "Cocoa",
        "-framework", "IOKit",
        "-framework", "CoreVideo",
        "-framework", "QuartzCore",
        "-framework", "Metal",
        "-framework", "MetalKit",
    ])
    # Link Vulkan/MoltenVK
    env.Append(LIBS=["vulkan"])

elif env["platform"] == "linux":
    env.Append(LIBS=["vulkan", "pthread", "dl"])

elif env["platform"] == "windows":
    env.Append(LIBS=["vulkan-1"])

# Gather sources
sources = Glob("src/*.cpp")

# Build the shared library
suffix = ".dylib" if env["platform"] == "macos" else ".so" if env["platform"] == "linux" else ".dll"
library = env.SharedLibrary(
    target="project/bin/libohao.{}.{}.{}{}".format(
        env["platform"],
        env["target"],
        env["arch"],
        suffix
    ),
    source=sources,
)

Default(library)
